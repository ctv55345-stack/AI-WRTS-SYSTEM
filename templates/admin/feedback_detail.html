{% extends "base/admin_base.html" %}

{% block title %}Chi tiết Phản hồi - AI-WRTS System{% endblock %}

{% block admin_content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1 gradient-text">
            <i class="fas fa-comment-dots me-2"></i>
            Chi tiết Phản hồi
        </h1>
        <p class="text-muted mb-0">Xem và xử lý phản hồi từ người dùng</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('admin.feedback_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Quay lại
        </a>
        <button class="btn btn-outline-primary" onclick="refreshPage()">
            <i class="fas fa-sync-alt"></i>
            Làm mới
        </button>
    </div>
</div>

<div class="row g-4">
    <!-- Feedback Information -->
    <div class="col-lg-8">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h3 class="admin-panel-title">
                    <i class="fas fa-info-circle"></i>
                    Thông tin phản hồi
                </h3>
                <div class="d-flex gap-2">
                    <span class="priority-badge priority-{{ feedback.priority or 'medium' }}">
                        {{ (feedback.priority or 'medium').title() }}
                    </span>
                    <span class="status-badge status-{{ feedback.feedback_status or 'pending' }}">
                        {% if feedback.feedback_status == 'pending' %}
                            <i class="fas fa-clock"></i> Chờ xử lý
                        {% elif feedback.feedback_status == 'in_progress' %}
                            <i class="fas fa-spinner"></i> Đang xử lý
                        {% elif feedback.feedback_status == 'resolved' %}
                            <i class="fas fa-check-circle"></i> Đã giải quyết
                        {% elif feedback.feedback_status == 'closed' %}
                            <i class="fas fa-times-circle"></i> Đã đóng
                        {% else %}
                            <i class="fas fa-question-circle"></i> Chưa xác định
                        {% endif %}
                    </span>
                </div>
            </div>
            
            <!-- Feedback Content -->
            <div class="feedback-detail-content">
                <div class="feedback-header">
                    <div class="feedback-user">
                        <div class="user-avatar-admin">
                            {{ feedback.user.full_name[0].upper() if feedback.user.full_name else feedback.user.username[0].upper() }}
                        </div>
                        <div class="user-details">
                            <div class="user-name">{{ feedback.user.full_name or feedback.user.username }}</div>
                            <div class="user-email">{{ feedback.user.email }}</div>
                            <small class="text-muted">@{{ feedback.user.username }}</small>
                        </div>
                    </div>
                    <div class="feedback-type">
                        <span class="badge bg-secondary">
                            {% if feedback.feedback_type == 'bug' %}
                                <i class="fas fa-bug"></i> Báo lỗi
                            {% elif feedback.feedback_type == 'feature' %}
                                <i class="fas fa-lightbulb"></i> Đề xuất tính năng
                            {% elif feedback.feedback_type == 'complaint' %}
                                <i class="fas fa-exclamation-triangle"></i> Khiếu nại
                            {% elif feedback.feedback_type == 'praise' %}
                                <i class="fas fa-heart"></i> Khen ngợi
                            {% else %}
                                <i class="fas fa-comment"></i> {{ feedback.feedback_type or 'Khác' }}
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="feedback-body">
                    <h4 class="feedback-subject">{{ feedback.subject or 'Không có tiêu đề' }}</h4>
                    
                    {% if feedback.message %}
                    <div class="feedback-message">
                        <h6>Nội dung phản hồi:</h6>
                        <div class="message-content">
                            {{ feedback.message|nl2br }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if feedback.resolution_notes %}
                    <div class="feedback-resolution">
                        <h6>Ghi chú xử lý:</h6>
                        <div class="resolution-content">
                            {{ feedback.resolution_notes|nl2br }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="feedback-footer">
                    <div class="feedback-dates">
                        <div class="date-item">
                            <i class="fas fa-calendar-plus text-primary"></i>
                            <span><strong>Gửi lúc:</strong> {{ feedback.created_at.strftime('%d/%m/%Y %H:%M') if feedback.created_at else 'N/A' }}</span>
                        </div>
                        {% if feedback.updated_at and feedback.updated_at != feedback.created_at %}
                        <div class="date-item">
                            <i class="fas fa-edit text-warning"></i>
                            <span><strong>Cập nhật lúc:</strong> {{ feedback.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Response Form -->
    <div class="col-lg-4">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h3 class="admin-panel-title">
                    <i class="fas fa-edit"></i>
                    Xử lý phản hồi
                </h3>
            </div>
            
            <form method="POST" id="feedbackResponseForm">
                {{ form.hidden_tag() }}
                
                <div class="mb-3">
                    <label class="form-label">Mức độ ưu tiên</label>
                    {{ form.priority(class="form-select") }}
                    {% if form.priority.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.priority.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Trạng thái xử lý</label>
                    {{ form.feedback_status(class="form-select") }}
                    {% if form.feedback_status.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.feedback_status.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Ghi chú xử lý</label>
                    {{ form.resolution_notes(class="form-control", rows="6", placeholder="Nhập ghi chú về cách xử lý phản hồi này...") }}
                    {% if form.resolution_notes.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.resolution_notes.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        Mô tả chi tiết về cách bạn đã xử lý phản hồi này
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i>
                        Cập nhật phản hồi
                    </button>
                    <a href="{{ url_for('admin.feedback_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                        Hủy
                    </a>
                </div>
            </form>
        </div>
        
        <!-- Quick Actions -->
        <div class="admin-panel mt-4">
            <div class="admin-panel-header">
                <h3 class="admin-panel-title">
                    <i class="fas fa-bolt"></i>
                    Thao tác nhanh
                </h3>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-outline-warning" onclick="quickAction('in_progress')">
                    <i class="fas fa-spinner"></i>
                    Đánh dấu đang xử lý
                </button>
                <button class="btn btn-outline-success" onclick="quickAction('resolved')">
                    <i class="fas fa-check-circle"></i>
                    Đánh dấu đã giải quyết
                </button>
                <button class="btn btn-outline-danger" onclick="quickAction('closed')">
                    <i class="fas fa-times-circle"></i>
                    Đóng phản hồi
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .feedback-detail-content {
        padding: 1.5rem 0;
    }
    
    .feedback-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--light-bg);
    }
    
    .feedback-body {
        margin-bottom: 2rem;
    }
    
    .feedback-subject {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
    }
    
    .feedback-message, .feedback-resolution {
        margin-bottom: 1.5rem;
    }
    
    .feedback-message h6, .feedback-resolution h6 {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }
    
    .message-content, .resolution-content {
        background: var(--light-bg);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary-color);
        white-space: pre-wrap;
        line-height: 1.6;
    }
    
    .resolution-content {
        border-left-color: var(--success-color);
        background: rgba(17, 153, 142, 0.05);
    }
    
    .feedback-footer {
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .feedback-dates {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .date-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-secondary);
    }
    
    .date-item i {
        width: 20px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .feedback-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .feedback-dates {
            gap: 0.5rem;
        }
        
        .date-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function refreshPage() {
        location.reload();
    }
    
    function quickAction(status) {
        const statusSelect = document.querySelector('select[name="feedback_status"]');
        const resolutionTextarea = document.querySelector('textarea[name="resolution_notes"]');
        
        // Set status
        statusSelect.value = status;
        
        // Add appropriate note if empty
        if (!resolutionTextarea.value.trim()) {
            const notes = {
                'in_progress': 'Đang xử lý phản hồi này...',
                'resolved': 'Phản hồi đã được giải quyết thành công.',
                'closed': 'Phản hồi đã được đóng.'
            };
            resolutionTextarea.value = notes[status] || '';
        }
        
        // Focus on resolution notes
        resolutionTextarea.focus();
    }
    
    // Form submission with loading state
    document.getElementById('feedbackResponseForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';
        submitBtn.disabled = true;
        
        // Re-enable after 5 seconds (in case of error)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });
    
    // Auto-save draft functionality
    let autoSaveTimeout;
    document.querySelector('textarea[name="resolution_notes"]').addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Save to localStorage as draft
            localStorage.setItem('feedback_draft_{{ feedback.feedback_id }}', this.value);
        }, 2000);
    });
    
    // Load draft on page load
    document.addEventListener('DOMContentLoaded', function() {
        const draft = localStorage.getItem('feedback_draft_{{ feedback.feedback_id }}');
        const textarea = document.querySelector('textarea[name="resolution_notes"]');
        if (draft && !textarea.value) {
            textarea.value = draft;
        }
    });
    
    // Clear draft on successful submission
    document.getElementById('feedbackResponseForm').addEventListener('submit', function() {
        localStorage.removeItem('feedback_draft_{{ feedback.feedback_id }}');
    });
</script>
{% endblock %}
